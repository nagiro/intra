<?php

require 'lib/model/om/BaseSitesPeer.php';


/**
 * Skeleton subclass for performing query and update operations on the 'sites' table.
 *
 * 
 *
 * This class was autogenerated by Propel 1.4.2 on:
 *
 * 10/13/10 11:26:13
 *
 * You should add additional methods to this class to meet the
 * application requirements.  This class will only be generated as
 * long as it does not already exist in the output directory.
 *
 * @package    lib.model
 */
class SitesPeer extends BaseSitesPeer {

    const HOSPICI_ID = 0;
    
    static public function getCriteriaActiu( $C )
    {
      $C->add(self::ACTIU,true);      
      return $C;
    }    
    
    static public function initialize( $idS )
    {
        $OO = self::retrieveByPK($idS);            
        if(!($OO instanceof Sites)):                                    		
        	$OO = new Sites();       
            $OO->setNom('');
            $OO->setActiu(true);     		            			    			    			        			
        endif;
         
       	return new SitesForm($OO,array('IDS'=>$idS));
    }

    static public function getSelect( $has_new = true , $no_labels = false )
    {
        $RET = array();
        $C = new Criteria();
        $C = self::getCriteriaActiu($C);
        if(!$no_labels):
            if($has_new) $RET[''] = 'Nou site...';
            else $RET['0'] = 'Escull una entitat... ';
        endif;
        foreach(self::doSelect($C) as $OS):
            $RET[$OS->getSiteId()] = $OS->getNom();
        endforeach;
        return $RET;
    }

    static public function getSelectUser($idU = 0)
    {
        $RET = array();
        $C = new Criteria();
        $C = self::getCriteriaActiu($C);        
        $C = UsuarisPeer::getCriteriaActiu($C,null);
        $C = UsuarisSitesPeer::getCriteriaActiu($C);
        $C->addJoin(self::SITE_ID, UsuarisSitesPeer::SITE_ID);
        $C->addJoin(UsuarisSitesPeer::USUARI_ID, UsuarisPeer::USUARIID);
        $C->add(UsuarisPeer::USUARIID,$idU);
        
        $RET['0'] = 'Escull una entitat...';
        foreach(self::doSelect($C) as $OS):
            $RET[$OS->getSiteId()] = $OS->getNom();
        endforeach;
        return $RET;
    }

    
    static public function getNom($idS)
    {
        $OS = self::retrieveByPK($idS);
        if($OS instanceof Sites):
            return $OS->getNom();
        else: 
            return "n/d";
        endif; 
    }
    
    static public function cercaTotsCampsSelect($q, $lim, $idS)
    {
        $RET = array();         
        $C = self::getCriteriaActiu(new Criteria());
        $C->add(self::NOM, '%'.$q.'%',CRITERIA::LIKE);        
        $C->setLimit($lim);        
    
        foreach(self::doSelect($C) as $U):
      		$RET[$U->getSiteid()] = array('clau'=>$U->getSiteid(),'text'=>$U->getNom());  		
      	endforeach;      
        
        return $RET;
    }
    
    static public function getSiteUsersCercaUser($q, $lim, $IDS)
    {        
        $C = self::getCriteriaActiu(new Criteria());
        $C = UsuarisPeer::CriteriaCerca($q,$C);
        if($IDS > 0):
            $C->addJoin(UsuarisPeer::USUARIID, UsuarisSitesPeer::USUARI_ID);
            $C->add(UsuarisSitesPeer::SITE_ID, $IDS);            
        endif; 
        $C->setLimit($lim);        
        
        foreach(UsuarisPeer::doSelect($C) as $U):
      		$RET[$U->getUsuariId()] = array('clau'=>$U->getUsuariId(),'text'=>$U->getNomComplet());  		
      	endforeach;      
        
        return $RET;                
    }
    
    static public function getSiteLogo($idS)
    {
        $OS = self::retrieveByPK($idS);
        if($OS instanceof Sites){
            $url = $OS->getLogourl();
            if(!empty($url)) return '/images/sites/'.$OS->getLogourl();
            else return "/images/hospici/hospici100_100.jpg";            
        }                                        
        else
        {
            return "/images/hospici/hospici100_100.jpg";
        }
            
    }






  static public function getCategoriesCercaHospici($CER)
  {
    $C = new Criteria();
//    $C->add(self::ACTIU, true);        
//    $C->add(self::IDCURSOS , $a_cursos , CRITERIA::IN );
//    $C->addJoin(TipusPeer::IDTIPUS, self::CATEGORIA);            
    
//    $RET = array(); $SOL = array();
    
    $RET[0] = array('NOM' => "Totes les categories..." , 'COUNT'=>0);
//    foreach(TipusPeer::doSelect($C) as $OT):
//        if(!isset($RET[$OT->getIdtipus()])) $RET[$OT->getIdtipus()] = array('NOM' => $OT->getTipusdesc(),'COUNT'=>0);        
//        $RET[$OT->getIdtipus()]['COUNT'] += 1;
//        $RET[0]['COUNT'] += 1;
//    endforeach;
        
    foreach($RET as $K=>$V):
//        $SOL[$K] = $V['NOM']." ({$V['COUNT']})";
        $SOL[$K] = $V['NOM'];            
    endforeach;
    
    return $SOL; 
    
  }        
                
  static public function getPoblacionsCercaHospici( $CER )
  {
    $C = new Criteria();
    
    $C = self::CriteriaCercaEntitatsHospici( $CER , $C );
        
    $C->add(SitesPeer::ACTIU, true);
    $C->addJoin(PoblacionsPeer::IDPOBLACIO, SitesPeer::POBLE);
    $C->addJoin(self::SITE_ID, SitesPeer::SITE_ID);
        
    $RET = array(); $SOL = array();
    
    $RET[0] = array('NOM' => "Tots els pobles..." , 'COUNT'=>0);
    foreach(PoblacionsPeer::doSelect($C) as $OP):
        if(!isset($RET[$OP->getIdpoblacio()])) $RET[$OP->getIdpoblacio()] = array('NOM' => $OP->getNom(),'COUNT'=>0);        
        $RET[$OP->getIdpoblacio()]['COUNT'] += 1;
        $RET[0]['COUNT'] += 1;
    endforeach;
    
    foreach($RET as $K=>$V):
        $SOL[$K] = $V['NOM']." ({$V['COUNT']})";
    endforeach;
    
    return $SOL; 
  }
   
  static private function CriteriaCercaEntitatsHospici( $CER , $C ){        
    
    //Agafo els sites que estan actius.      
    $C->add(self::ACTIU, true);    

    if( !empty($CER['TEXT']) ) {        
        $C->add(self::NOM, '%'.$CER['TEXT'].'%', Criteria::LIKE);                
    }
        
    if(  $CER['POBLE'] > 0 ){        
        $C->add(self::POBLE, $CER['POBLE']);
    }
    
/* Encara no existeix la categoria en les entitats
    if(  $CER['CATEGORIA'] > 0 ){
        $C->addJoin(self::SITE_ID, SitesPeer::SITE_ID);
        $C->add(SitesPeer::POBLE, $CER['POBLE']);
    }
*/    
    $C->addAscendingOrderByColumn(self::NOM);    
    
    return $C;
    
  }
        
  static public function getEntitatsCercaHospici($CER)
  {
    
    $C = new Criteria();
       
    $C = self::CriteriaCercaEntitatsHospici( $CER , $C );
                                
    //Ara fem la select dels cursos amb el pager        
    $pager = new sfPropelPager('Sites', 20);
    $pager->setCriteria($C);
    $pager->setPage($CER['P']);
    $pager->init();    	                
       
    return $pager;
    
  }





    
} // SitesPeer
